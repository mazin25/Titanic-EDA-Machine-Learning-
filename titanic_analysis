library(tidyverse)
library(VIM)
library(naniar)
library(stringr)

#Data Importing
  train <- read.csv("train.csv")
  test <- read.csv("test.csv")

#Data Processing

  #joining the train and test data into one
  data <- rbind(train, mutate(test, Survived = NA))
  str(data)
  
  #Changing Data types 
    train$Survived <- as.factor(train$Survived)
    data$Survived <- as.factor(data$Survived)

    train$Pclass <- as.factor(train$Pclass)
    test$Pclass <- as.factor(test$Pclass)
    data$Pclass <- as.factor(data$Pclass)

    train$Sex <- as.factor(train$Sex)
    test$Sex <- as.factor(test$Sex)
    data$Sex <- as.factor(data$Sex)

    train$Title <- as.factor(train$Title)
    test$Title <- as.factor(test$Title)
    data$Title <- as.factor(data$Title)

    train$Age <- as.integer(train$Age)
    test$Age <- as.integer(test$Age)
    data$Age <- as.integer(data$Age)

  #Feature Engineering
    #create a title col from Name col 
      #checking for missing Names in both train and Test Data
      sum(is.na(data$Name))
      #mutate the new Title col in all data sets
      data <- data %>%
        mutate(Title = str_extract(Name, "(?<=\\s)[[:alpha:]]+(?=\\.)" ))
      train <- train %>%
        mutate(Title = str_extract(Name, "(?<=\\s)[[:alpha:]]+(?=\\.)" ))
      test <- test %>%
        mutate(Title = str_extract(Name, "(?<=\\s)[[:alpha:]]+(?=\\.)" ))
      
    #create a Family col from Name col 
      data <- data %>%
        mutate(Family = str_extract(tolower(Name), ".+(?=,)"))
      train <- train %>%
        mutate(Family = str_extract(tolower(Name), ".+(?=,)"))
      test <- test %>%
        mutate(Family = str_extract(tolower(Name), ".+(?=,)"))
     #create a Fare-per-person col by dividing the total fare price by the size of ticket
      train <- train %>% 
        group_by(Ticket) %>%
        mutate(Fare_per_person = Fare/n()) %>%
        ungroup()
      test <- test %>% 
        group_by(Ticket) %>%
        mutate(Fare_per_person = Fare/n()) %>%
        ungroup()
      data <- data %>% 
        group_by(Ticket) %>%
        mutate(Fare_per_person = Fare/n()) %>%
        ungroup()
     #create family number using parch and sibsp variables  
      train <- train %>%
        mutate(FamilyCount = SibSp + Parch + 1)
      test <- test %>%
        mutate(FamilyCount = SibSp + Parch + 1)
      data <- data %>%
        mutate(FamilyCount = SibSp + Parch + 1)
        
  #Null-values handling
    #convert any "" in Cabin into Null value
    data <- data %>%
      mutate(Cabin = ifelse(Cabin == "", NA, Cabin))
    train <- train %>%
      mutate(Cabin = ifelse(Cabin == "", NA, Cabin))
    test <- test %>%
      mutate(Cabin = ifelse(Cabin == "", NA, Cabin))
      
    #Exploring null values in training set
    colSums(is.na(train))
    aggr(train, data = TRUE, numbers = c(TRUE, TRUE))
    vis_miss(train)
    

